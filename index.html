<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mesh Sticker Generator</title>

<style>
@font-face{
  font-family:'MeshFont';
  src:url('fonts/MeshFont.ttf') format('truetype');
  font-display:swap;
}

html,body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:MeshFont, system-ui, -apple-system, BlinkMacSystemFont, Inter, Arial, sans-serif;
}

body{
  display:flex;
  justify-content:center;
  padding:20px;
}

.container{
  width:100%;
  max-width:420px;
}

h1{
  text-align:center;
  font-size:16px;
  margin-bottom:10px;
  opacity:.7;
}

select,button,input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
  border:none;
  font-size:14px;
}

button{
  background:#1db954;
  color:#fff;
  cursor:pointer;
}

canvas{
  width:100%;
  height:auto;
  background:transparent;
  border-radius:12px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="container">

<h1>Mesh Sticker — ART GEN</h1>

<select id="showPicker" disabled>
  <option>Loading shows…</option>
</select>

<input type="text" id="guestInput" placeholder="Add Guest (optional)">

<button id="downloadBtn" disabled>Download Sticker</button>

<canvas id="c" width="600" height="600"></canvas>

</div>

<script>
/* ===========================
   CONFIG
=========================== */

const SHEET_URL =
  "https://script.google.com/macros/s/AKfycbw3QgJtZXB48I0BUMpTE5Dlo2kqMReNuD4jbiEVBaB1z49bSgzEkAgixkjHxwTKRwY0/exec";

const HERO = {
  size: 360,
  y: 40,
  radius: 16
};

const PILL_LEFT = 40;
const MAX_PILL_WIDTH = 520;
const PILL_PADDING_X = 32;
const DATE_TIME_GAP = 12;

/* ===========================
   STATE
=========================== */

let shows = [];

/* ===========================
   LOAD SHOWS
=========================== */
async function loadShows(){
  const picker = document.getElementById('showPicker');

  try{
    const res = await fetch(SHEET_URL);
    shows = await res.json();
  }catch(e){
    console.error('Failed to load shows', e);
    shows = [];
  }

  picker.innerHTML = '<option disabled selected>Select a show</option>';

  shows.forEach((s,i)=>{
    const d = new Date(s.Date);
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent =
      `${d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})} — ${s['Now Playing']}`;
    picker.appendChild(opt);
  });

  picker.disabled = false;
}

/* ===========================
   EVENTS
=========================== */

showPicker.addEventListener('change', drawSticker);

/* ===========================
   HELPERS
=========================== */

function to12h(time){
  if(!time) return '';
  const [h,m] = time.split(':').map(Number);
  const hr = ((h + 11) % 12) + 1;
  return `${hr}${m ? ':'+String(m).padStart(2,'0') : ''}${h >= 12 ? 'pm' : 'am'}`;
}

function drawWhitePill(ctx,x,y,w,h){
  ctx.fillStyle='#fff';
  ctx.beginPath();
  ctx.roundRect(x,y,w,h,16);
  ctx.fill();
}

function drawRoundedCover(ctx,img,x,y,size,r){
  ctx.save();
  ctx.beginPath();
  ctx.roundRect(x,y,size,size,r);
  ctx.clip();

  const scale = Math.max(size / img.width, size / img.height);
  const w = img.width * scale;
  const h = img.height * scale;

  ctx.drawImage(
    img,
    x + (size - w) / 2,
    y + (size - h) / 2,
    w,
    h
  );
  ctx.restore();
}

/* ===========================
   DRAW STICKER
=========================== */
function drawSticker(){
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const cw = canvas.width;

  const show = shows[showPicker.value];
  if(!show || !show['Image URL']) return;

  ctx.clearRect(0,0,cw,canvas.height);

  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.src = show['Image URL'];

  img.onload = () => {

    /* HERO IMAGE */
    drawRoundedCover(
      ctx,
      img,
      (cw - HERO.size) / 2,
      HERO.y,
      HERO.size,
      HERO.radius
    );

    const heroBottom = HERO.y + HERO.size;

    /* PRIMARY / SECONDARY */
    const guest = guestInput.value.trim();
    const title = show['Now Playing'] || '';
    const dj = show['DJ'] || '';

    const showEqualsDJ =
      dj && title.toLowerCase() === dj.toLowerCase();

    let primaryLine = title;
    let secondaryLine = '';

    if(showEqualsDJ){
      if(guest) primaryLine = `${title} + ${guest}`;
    } else {
      secondaryLine = dj + (guest ? ' + ' + guest : '');
    }

    /* MEASURE */
    ctx.font = '52px MeshFont';
    const pw = ctx.measureText(primaryLine).width;

    ctx.font = '36px MeshFont';
    const sw = secondaryLine ? ctx.measureText(secondaryLine).width : 0;

    const pillW = Math.min(
      MAX_PILL_WIDTH,
      Math.max(pw, sw) + PILL_PADDING_X * 2
    );

    const pillH = secondaryLine ? 130 : 88;
    const pillY = heroBottom - 44;

    drawWhitePill(ctx, PILL_LEFT, pillY, pillW, pillH);

    const centerY = pillY + pillH / 2;

    ctx.fillStyle='#000';
    ctx.textAlign='left';
    ctx.textBaseline='middle';

    ctx.font='52px MeshFont';
    ctx.fillText(primaryLine, PILL_LEFT + PILL_PADDING_X, secondaryLine ? centerY - 20 : centerY);

    if(secondaryLine){
      ctx.globalAlpha = 0.75;
      ctx.font='36px MeshFont';
      ctx.fillText(secondaryLine, PILL_LEFT + PILL_PADDING_X, centerY + 22);
      ctx.globalAlpha = 1;
    }

    /* DATE / TIME */
    const dateStr = new Date(show.Date)
      .toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});

    const [s,e] = (show['A-B'] || '').split('-');
    const timeStr = `${to12h(s)} → ${to12h(e)}`;

    ctx.font='28px MeshFont';
    const dateW = ctx.measureText(dateStr).width + 36;
    const timeW = ctx.measureText(timeStr).width + 36;

    const dtY = pillY + pillH + 10;

    drawWhitePill(ctx, PILL_LEFT, dtY, dateW, 48);
    drawWhitePill(ctx, PILL_LEFT + dateW + DATE_TIME_GAP, dtY, timeW, 48);

    ctx.fillStyle='#000';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(dateStr, PILL_LEFT + dateW/2, dtY + 24);
    ctx.fillText(timeStr, PILL_LEFT + dateW + DATE_TIME_GAP + timeW/2, dtY + 24);

    downloadBtn.disabled = false;
  };
}

/* ===========================
   DOWNLOAD
=========================== */
downloadBtn.onclick = async () => {
  const blob = await new Promise(r => c.toBlob(r,'image/png',1));

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mesh_sticker.png';
  a.click();

  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
};

window.onload = loadShows;
</script>
</body>
</html>
